<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Primal4k Radio</title>
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#FF0000">

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>
  <script>
    window.OneSignal = window.OneSignal || [];
    OneSignal.push(function() {
      OneSignal.init({
        appId: "d651859b-b89b-4271-83b0-d944f07d9671",
        notifyButton: { enable: true },
        allowLocalhostAsSecureOrigin: true
      });
    });
  </script>
</head>
<body>
  <h1>Primal4k Radio</h1>
  <div id="player-bar" style="position:fixed; bottom:0; left:0; right:0; background:#111; color:#fff; display:flex; align-items:center; padding:10px; font-family:sans-serif;">
    <button id="playPauseBtn" style="margin-right:10px;">‚è∏Ô∏è</button>
    <span id="status">Connecting...</span>
  </div>

  <script>
    const streamUrl = "https://fast.citrus3.com:8014/;";
    const audio = new Audio(streamUrl);
    audio.autoplay = true;
    audio.preload = "auto";
    audio.crossOrigin = "anonymous";
    audio.controls = false;

    let retryCount = 0;
    const status = document.getElementById("status");
    const playPauseBtn = document.getElementById("playPauseBtn");

    function playStream() {
      audio.play().then(() => {
        retryCount = 0;
        status.textContent = "üîä Live Now";
        playPauseBtn.textContent = "‚è∏Ô∏è";
      }).catch(err => {
        console.error("Play error:", err);
        status.textContent = "‚ö†Ô∏è Reconnecting...";
        scheduleReconnect();
      });
    }

    function scheduleReconnect() {
      if (retryCount < 5) {
        retryCount++;
        setTimeout(() => {
          status.textContent = `üîÑ Reconnect attempt ${retryCount}`;
          playStream();
        }, 2000 * retryCount);
      } else {
        status.textContent = "‚ùå Unable to connect";
      }
    }

    audio.addEventListener("playing", () => {
      status.textContent = "üîä Live Now";
      retryCount = 0;
    });

    ["stalled", "error", "ended"].forEach(evt => {
      audio.addEventListener(evt, () => {
        console.warn("Audio issue:", evt);
        status.textContent = "‚ö†Ô∏è Stream dropped, retrying...";
        scheduleReconnect();
      });
    });

    playPauseBtn.addEventListener("click", () => {
      if (audio.paused) {
        playStream();
      } else {
        audio.pause();
        playPauseBtn.textContent = "‚ñ∂Ô∏è";
        status.textContent = "‚è∏Ô∏è Paused";
      }
    });

    // Service Worker registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(() => console.log('Service Worker Registered'))
        .catch(err => console.error('SW Registration Failed:', err));
    }

    // Optional add-to-home-screen prompt alert
    if (!window.matchMedia('(display-mode: standalone)').matches) {
      alert('Add this page to your home screen for full app experience!');
    }

    playStream();
  </script>
</body>
</html>